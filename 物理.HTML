<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>高二物理練習 - 測量與不確定度（單題顯示｜20題）</title>
<style>
body{font-family:system-ui,"Microsoft JhengHei",sans-serif;background:#0b1020;color:#e9ecf8;margin:0}
header{padding:16px;background:#111734}
h1{font-size:20px;margin:0}
.panel{background:#111734;padding:16px;border-radius:10px;margin:10px}
.pill{display:inline-block;background:#0f1533;padding:6px 10px;border-radius:999px;margin:2px}
.btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#2a3585;color:#fff}
.btn.warn{background:#ffcc66}
.btn.bad{background:#f7768e;color:#fff}
.qcard{background:#0f1533;padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid #232c63}
.choice{padding:8px;border:1px solid #232c63;border-radius:8px;margin:6px 0;cursor:pointer}
.choice.correct{border-color:#55d187;background:#0c1f18}
.choice.wrong{border-color:#f7768e;background:#271018}
.explain{display:none;background:#0f1533;padding:8px;margin-top:8px;border-left:3px solid #2e4284;border-radius:6px}
.explain.show{display:block}
.progress{height:8px;background:#10163a;border-radius:4px;overflow:hidden;margin-bottom:6px}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#7aa2f7,#55d187)}
.small{opacity:.85;font-size:13px}
.tag{display:inline-block;background:#17204a;border:1px solid #2e3a7e;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
</style>
</head>
<body>
<header>
  <h1>高二物理練習（108課綱）— 第一章｜測量與不確定度（單題顯示｜20題）</h1>
</header>

<div class="panel">
  <span class="pill">模式
    <select id="mode">
      <option value="practice">練習（立即顯示解析）</option>
      <option value="exam">模擬測驗（交卷後一次看解析）</option>
    </select>
  </span>
  <button class="btn" id="startBtn">開始練習</button>
  <button class="btn bad" id="clearBtn">清除進度</button>

  <div class="progress"><div class="bar" id="progressBar"></div></div>
  <div id="progressText" class="small">尚未開始</div>
  <div class="small">正確：<b id="okCount">0</b> ｜ 錯誤：<b id="badCount">0</b></div>
</div>

<div id="questionArea" style="margin:10px;"></div>

<div class="panel" id="navArea" style="display:none;gap:8px">
  <button class="btn secondary" id="prevBtn">上一題</button>
  <button class="btn secondary" id="nextBtn">下一題</button>
  <button class="btn warn" id="submitBtn">交卷</button>
</div>

<div id="resultArea" style="display:none;margin:10px">
  <div class="qcard">
    <h3 style="margin:0 0 8px">成績與解析</h3>
    <div id="scoreLine" class="small"></div>
  </div>
  <div id="reviewArea"></div>
</div>

<script>
// ========= 基本工具 =========
const rndi = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const toFixedSmart = (x,d=2)=>Number(x).toFixed(d).replace(/\.00$/,'');
const shuffle = (a)=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

// 生成四選項（保持正確答案存在）
function makeChoices(correct, distractors){
  const arr = [correct, ...distractors];
  // 剛好四個就洗牌；多或少就修正
  const four = arr.slice(0,4);
  shuffle(four);
  const answer = four.indexOf(correct);
  return {choices: four, answer};
}

// ========= 題型產生器（第一章） =========
function gen_t1(){
  const type = ['sigfig','perror','sum_unc'][rndi(0,2)];

  if(type==='sigfig'){
    // 三種不同型態輪流出
    const pattern = rndi(1,3);
    let raw, ans;
    if(pattern===1){
      raw = '0.' + '0'.repeat(rndi(1,3)) + String(rndi(10,99)); // 0.00ab
      ans = 2;
    }else if(pattern===2){
      const base = rndi(1,9)*1000; // 3000
      const style = ['plain','dot','sci'][rndi(0,2)];
      if(style==='plain'){ raw=String(base); ans=1; }
      else if(style==='dot'){ raw=String(base)+'.'; ans=4; }
      else { // 科學記號
        const sig = rndi(2,4);
        raw = (base/1000).toFixed(sig-1)+'×10^3';
        ans = sig;
      }
    }else{
      const dec = (rndi(10,99)/1000).toFixed(rndi(2,4)); // 0.0xxx
      raw = String(dec);
      ans = String(dec).replace(/^0\./,'').replace(/0+$/,'').length;
    }
    const correct = ans+' 位';
    const {choices,answer} = makeChoices(correct, [
      (ans-1)+' 位',
      (ans+1)+' 位',
      (ans===1?3:ans-2)+' 位'
    ]);
    return {
      stem:`下列數值的有效數字為幾位？ ${raw}`,
      choices, answer,
      explanation:`判斷規則：1) 前導零不算；2) 小數點右側末尾零算；3) 科學記號中的係數全部算。以本題 ${raw} 可得 ${ans} 位。`,
      life:`生活例子：電子秤顯示 0.0340 kg，末尾 0 代表解析度，需算入有效數字。`
    };
  }

  if(type==='perror'){
    const truev = rndi(50,200);
    const meas = truev + rndi(-5,5);
    const perror = Math.abs((meas-truev)/truev)*100;
    const correct = toFixedSmart(perror,2)+'%';
    const {choices,answer} = makeChoices(correct, [
      toFixedSmart(perror*2,2)+'%',
      toFixedSmart(perror/2,2)+'%',
      toFixedSmart(perror + rndi(1,5),2)+'%'
    ]);
    return {
      stem:`某物理量真值為 ${truev}，量得 ${meas}，百分誤差約為？`,
      choices, answer,
      explanation:`百分誤差＝|測量值−真值|/真值×100%＝|${meas}−${truev}|/${truev}×100%≈${correct}。`,
      life:`生活例子：量身高若尺未貼齊牆面，讀數偏大，會造成百分誤差。`
    };
  }

  // 加減法不確定度（取最差小數位）
  const a = (rndi(120,235)/100).toFixed(2);
  const b = (rndi(95,140)/100).toFixed(2);
  const sum = (parseFloat(a)+parseFloat(b)).toFixed(2);
  const correct = `${sum} cm`;
  const {choices,answer} = makeChoices(correct, [
    (parseFloat(sum)).toFixed(3)+' cm',
    (parseFloat(sum)).toFixed(1)+' cm',
    (Math.round(parseFloat(sum)*10)/10).toFixed(1)+' cm'
  ]);
  return {
    stem:`將兩長度相加：${a} cm 與 ${b} cm，結果應表達為？（依最差位數原則）`,
    choices, answer,
    explanation:`加減法以最差小數位為準。兩者皆至 0.01 cm，故結果保留至 0.01 cm：${a}+${b}=${sum} cm。`,
    life:`生活例子：量桌長與桌寬相加估對角線時，結果呈現要以較差的位數為準。`
  };
}

// ========= 狀態與元素 =========
let bank = [];           // 20 題題庫（資料）
let idx = 0;             // 當前題目索引
let done = false;        // 是否已交卷
let ok = 0, bad = 0;     // 統計

const questionArea = document.getElementById('questionArea');
const navArea = document.getElementById('navArea');
const resultArea = document.getElementById('resultArea');
const scoreLine = document.getElementById('scoreLine');
const reviewArea = document.getElementById('reviewArea');
const okCountEl = document.getElementById('okCount');
const badCountEl = document.getElementById('badCount');
const bar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

// ========= 渲染單題 =========
function renderOne(){
  const q = bank[idx];
  questionArea.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'qcard';
  card.innerHTML = `
    <div class="small"><span class="tag">第一章｜測量與不確定度</span> 第 ${idx+1} / ${bank.length} 題</div>
    <div style="margin:6px 0 10px">${q.stem}</div>
    <div id="choices"></div>
    <div class="explain" id="explain"><b>詳解：</b>${q.explanation}<br><b>生活化例子：</b>${q.life}</div>
  `;
  const ch = card.querySelector('#choices');

  q.choices.forEach((c, j)=>{
    const opt = document.createElement('div');
    opt.className = 'choice';
    opt.dataset.choice = String(j);
    opt.innerHTML = `<b>${'ABCD'[j]}</b> ${c}`;
    ch.appendChild(opt);
  });

  // 若已作答過，回填樣式與解析
  if (q.userAnswered !== undefined){
    const items = ch.querySelectorAll('.choice');
    items.forEach((el, j)=>{
      if (j===q.answer) el.classList.add('correct');
      if (j===q.userAnswered && j!==q.answer) el.classList.add('wrong');
    });
    document.getElementById('explain').classList.add('show');
  }

  questionArea.appendChild(card);
  updateProgress();
}

// ========= 事件委派（點選選項） =========
questionArea.addEventListener('click', (e)=>{
  if (done) return;
  const opt = e.target.closest('.choice');
  if (!opt) return;

  const q = bank[idx];
  const choice = parseInt(opt.dataset.choice);

  // 允許重選：先清除樣式
  const items = questionArea.querySelectorAll('.choice');
  items.forEach(el=>el.classList.remove('correct','wrong'));

  // 樣式標示
  items.forEach((el, j)=>{
    if (j===q.answer) el.classList.add('correct');
    if (j===choice && j!==q.answer) el.classList.add('wrong');
  });

  // 統計（若是第一次作答才計入）
  if (q.userAnswered === undefined){
    if (choice===q.answer) ok++; else bad++;
  }else{
    // 若是重選：先回退舊統計，再計入新選
    if (q.userAnswered===q.answer) ok--; else bad--;
    if (choice===q.answer) ok++; else bad++;
  }
  q.userAnswered = choice;

  // 練習模式立即顯示解析；模考模式也改為立即顯示（避免「覺得點不動」）
  document.getElementById('explain').classList.add('show');

  updateProgress();
});

// ========= 進度條與統計 =========
function updateProgress(){
  const answered = bank.filter(q=>q.userAnswered!==undefined).length;
  okCountEl.textContent = ok;
  badCountEl.textContent = bad;
  bar.style.width = `${(answered/bank.length)*100}%`;
  progressText.textContent = `已作答 ${answered}/${bank.length} 題`;
}

// ========= 控制：開始 / 上一題 / 下一題 / 交卷 / 清除 =========
document.getElementById('startBtn').addEventListener('click', ()=>{
  // 產生 20 題
  bank = Array.from({length:20}, ()=>gen_t1());
  idx = 0; done = false; ok = 0; bad = 0;
  navArea.style.display = 'block';
  resultArea.style.display = 'none';
  renderOne();
});

document.getElementById('prevBtn').addEventListener('click', ()=>{
  if (idx>0){ idx--; renderOne(); }
});
document.getElementById('nextBtn').addEventListener('click', ()=>{
  if (idx<bank.length-1){ idx++; renderOne(); }
});

document.getElementById('submitBtn').addEventListener('click', ()=>{
  if (done) return;
  done = true;
  const total = bank.length;
  const score = Math.round(100*ok/total);
  scoreLine.innerHTML = `本次成績：<b>${score} 分</b>（正確 ${ok}／錯誤 ${bad}，共 ${total} 題）`;
  // 錯題回顧
  reviewArea.innerHTML = '';
  bank.forEach((q,i)=>{
    if (q.userAnswered===q.answer) return;
    const div = document.createElement('div');
    div.className = 'qcard';
    const ua = (q.userAnswered===undefined)?'未作答':q.choices[q.userAnswered];
    div.innerHTML = `<div class="small"><span class="tag">錯題</span> 第 ${i+1} 題</div>
      <div style="margin-top:6px"><b>題目：</b>${q.stem}</div>
      <div style="margin-top:6px"><b>你的作答：</b>${ua} ｜ <b>正確答案：</b>${q.choices[q.answer]}</div>
      <div class="explain show" style="margin-top:8px"><b>詳解：</b>${q.explanation}<br><b>生活化例子：</b>${q.life}</div>`;
    reviewArea.appendChild(div);
  });
  resultArea.style.display = 'block';
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  // 清畫面，不動 localStorage（本版本未使用 localStorage）
  bank = []; idx = 0; done = false; ok = 0; bad = 0;
  questionArea.innerHTML = '';
  navArea.style.display = 'none';
  resultArea.style.display = 'none';
  bar.style.width = '0%';
  progressText.textContent = '尚未開始';
  okCountEl.textContent = '0';
  badCountEl.textContent = '0';
});

</script>
</body>
</html>
